# TASK-103: シグナリングハンドラー実装 - TDDテストケース洗い出し

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: WebRTC型定義の完全性、Socket.IOとの親和性、複雑な非同期処理の型安全性
  - **テストに適した機能**: インターフェース定義による明確なシグナリング契約、Mock/Stubによるネットワーク処理テスト
- **テストフレームワーク**: Jest + Socket.IO Client (テスト用) + WebRTC Mock
  - **フレームワーク選択の理由**: WebRTCシグナリング特有のイベント駆動テスト、RTCSessionDescription/RTCIceCandidateのモック対応
  - **テスト実行環境**: Socket.IOテストクライアント、WebRTC APIモック、複数接続シミュレーション
- 🟢 既存プロジェクトの技術スタック（REQ-402, REQ-406）準拠、TASK-102参加者管理基盤に依存

## 1. 正常系テストケース（基本的な動作）

### 1.1 SignalingHandlerクラス初期化テスト
- **テスト名**: SignalingHandlerクラスが正常に初期化できる
  - **何をテストするか**: SignalingHandlerインスタンス生成とSocket.IOイベントハンドラー登録
  - **期待される動作**: offer, answer, ice-candidateイベントリスナーの正常登録
- **入力値**: Socket.IOサーバーインスタンス、RoomManagerインスタンス
  - **入力データの意味**: シグナリング機能に必要な依存コンポーネント
- **期待される結果**: 正常インスタンス生成、イベントハンドラー登録確認
  - **期待結果の理由**: WebRTCシグナリング基盤の初期化確認
- **テストの目的**: シグナリングハンドラー基盤の正常性確認
  - **確認ポイント**: イベントリスナー登録、依存関係注入、初期状態
- 🟢 要件定義書のSignalingHandlerクラス設計に基づく

### 1.2 Offerメッセージ中継テスト
- **テスト名**: Offerシグナリングメッセージが正常に中継される
  - **何をテストするか**: 'offer'イベント受信時の宛先参加者への中継処理
  - **期待される動作**: 送信者検証、宛先検証、メッセージ中継、フォーマット保持
- **入力値**: 
  ```typescript
  {
    from: "participant-A",
    to: "participant-B", 
    signal: {
      type: "offer",
      sdp: "v=0\r\no=- 123 0 IN IP4 192.168.1.100\r\n..."
    }
  }
  ```
  - **入力データの意味**: WebRTC接続確立のためのOffer情報（実際のSDP形式）
- **期待される結果**: participant-Bへの正確なoffer配信、SDPデータ完全保持
  - **期待結果の理由**: P2P音声通話実現のためのシグナリング完全性
- **テストの目的**: 基本的なシグナリング中継機能の動作確認
  - **確認ポイント**: メッセージルーティング、データ完全性、宛先特定
- 🟢 要件定義書のOffer/Answer交換フロー、REQ-003要件に基づく

### 1.3 Answerメッセージ中継テスト
- **テスト名**: Answerシグナリングメッセージが正常に中継される
  - **何をテストするか**: 'answer'イベント受信時の送信者への返答中継処理
  - **期待される動作**: Answer応答の正確な送信者への配信
- **入力値**:
  ```typescript
  {
    from: "participant-B",
    to: "participant-A",
    signal: {
      type: "answer", 
      sdp: "v=0\r\no=- 456 0 IN IP4 192.168.1.101\r\n..."
    }
  }
  ```
  - **入力データの意味**: OfferへのAnswer応答（WebRTC接続確立完了情報）
- **期待される結果**: participant-Aへの正確なanswer配信、SDP応答データ保持
  - **期待結果の理由**: WebRTC接続確立の双方向シグナリング完了
- **テストの目的**: 双方向シグナリング処理の正確性確認
  - **確認ポイント**: 逆方向ルーティング、応答データ完全性
- 🟢 要件定義書のOffer/Answer交換フロー、WebRTC標準仕様に基づく

### 1.4 ICE候補中継テスト
- **テスト名**: ICE候補メッセージが正常に中継される
  - **何をテストするか**: 'ice-candidate'イベント受信時の候補情報中継処理
  - **期待される動作**: ICE候補の正確な相手への配信、複数候補の順次処理
- **入力値**:
  ```typescript
  {
    from: "participant-A",
    to: "participant-B",
    candidate: {
      candidate: "candidate:1 1 UDP 2130706431 192.168.1.100 54400 typ host",
      sdpMLineIndex: 0,
      sdpMid: "audio"
    }
  }
  ```
  - **入力データの意味**: WebRTC接続のためのICE候補情報（ネットワーク経路情報）
- **期待される結果**: participant-Bへの正確なice-candidate配信、候補データ保持
  - **期待結果の理由**: NAT越えを含むWebRTC接続確立のための経路情報交換
- **テストの目的**: ICE候補交換機能の正確性確認
  - **確認ポイント**: 候補データ完全性、複数候補処理、タイミング管理
- 🟢 要件定義書のICE候補交換、WebRTCプロトコル仕様に基づく

### 1.5 複数ピア間シグナリングテスト
- **テスト名**: 複数参加者間の並行シグナリングが正常に処理される
  - **何をテストするか**: 1人の新規参加者と複数既存参加者間の同時接続確立
  - **期待される動作**: 複数のOffer/Answer/ICE交換の並行処理、メッセージ混合なし
- **入力値**: participant-Cと participant-A、participant-B間の3つの並行シグナリング
  - **入力データの意味**: メッシュ型接続での新規参加者の複数接続確立
- **期待される結果**: 各ペア間の独立したシグナリング完了、混線なし
  - **期待結果の理由**: REQ-003（全員音声送受信）のためのメッシュ型接続実現
- **テストの目的**: 複数ピア対応シグナリングの正確性確認
  - **確認ポイント**: 並行処理正確性、メッセージ分離、状態管理独立性
- 🟢 architecture.mdのメッシュ型トポロジー、複数ピア対応要件に基づく

### 1.6 参加者検証機能テスト
- **テスト名**: 送信者・宛先の参加者リスト内存在確認が正常に動作する
  - **何をテストするか**: シグナリングメッセージ中継前の参加者有効性確認
  - **期待される動作**: RoomManagerとの連携による参加者存在確認、有効時のみ中継
- **入力値**: 有効な参加者ID間でのシグナリングメッセージ
  - **入力データの意味**: 正当な参加者間でのWebRTC接続試行
- **期待される結果**: 参加者確認成功、メッセージ中継実行
  - **期待結果の理由**: 不正なシグナリング防止、セキュリティ確保
- **テストの目的**: 参加者認証機能の正確性確認
  - **確認ポイント**: RoomManager連携、存在確認ロジック、承認フロー
- 🟡 要件定義書の参加者認証要件、セキュリティ制約に基づく

## 2. 異常系テストケース（エラーハンドリング）

### 2.1 存在しない宛先参加者へのメッセージ送信エラー
- **テスト名**: 存在しない参加者IDへのシグナリング時にエラーが返される
  - **エラーケースの概要**: 無効な宛先参加者IDでのシグナリングメッセージ送信
  - **エラー処理の重要性**: 不正なシグナリング防止、リソース浪費回避
- **入力値**: 存在しない宛先 "nonexistent-participant" へのofferメッセージ
  - **不正な理由**: 参加者リストに存在しない無効なID
  - **実際の発生シナリオ**: 参加者退出後の遅延メッセージ、クライアント側バグ
- **期待される結果**: 
  ```typescript
  {
    code: "SIGNALING_ERROR",
    message: "宛先参加者が見つかりません"
  }
  ```
  - **エラーメッセージの内容**: 明確な原因説明とユーザー対応指示
  - **システムの安全性**: 無効な宛先へのメッセージ配信防止
- **テストの目的**: 無効宛先エラーハンドリングの確認
  - **品質保証の観点**: 不正シグナリング防止、システム堅牢性向上
- 🟡 要件定義書の無効宛先エラー、エラーハンドリング制約に基づく

### 2.2 存在しない送信者からのメッセージ受信エラー
- **テスト名**: 参加者リストにない送信者からのシグナリング時にエラーが返される
  - **エラーケースの概要**: 無効な送信者IDからのシグナリングメッセージ受信
  - **エラー処理の重要性**: なりすまし防止、不正アクセス遮断
- **入力値**: 存在しない送信者 "invalid-sender" からのofferメッセージ
  - **不正な理由**: 参加者として登録されていない無効なID
  - **実際の発生シナリオ**: 不正なクライアント、認証なしアクセス試行
- **期待される結果**: 送信者認証エラー、メッセージ中継拒否
  - **エラーメッセージの内容**: 認証失敗を示すセキュリティメッセージ
  - **システムの安全性**: 不正送信者からの攻撃防止
- **テストの目的**: 送信者認証機能の実効性確認
  - **品質保証の観点**: セキュリティ境界の堅牢性、なりすまし防止
- 🟡 要件定義書の参加者認証要件、セキュリティ要件に基づく

### 2.3 不正なSignalDataフォーマットエラー
- **テスト名**: 無効なWebRTCシグナリングデータ形式時にエラーが返される
  - **エラーケースの概要**: RTCSessionDescriptionInit形式に準拠しないデータ受信
  - **エラー処理の重要性**: WebRTC接続失敗防止、プロトコル準拠保証
- **入力値**: 不正なSDP形式のofferメッセージ
  ```typescript
  {
    from: "participant-A",
    to: "participant-B",
    signal: {
      type: "offer",
      sdp: "invalid-sdp-format"
    }
  }
  ```
  - **不正な理由**: WebRTC標準に準拠しないSDP形式
  - **実際の発生シナリオ**: クライアント側WebRTC実装バグ、データ破損
- **期待される結果**: フォーマット検証エラー、中継拒否
  - **エラーメッセージの内容**: SDP形式エラーの詳細情報
  - **システムの安全性**: 不正データによるWebRTC接続障害防止
- **テストの目的**: データ検証機能の完全性確認
  - **品質保証の観点**: プロトコル準拠性、接続品質保証
- 🟡 WebRTC標準仕様、データ検証要件からの推測

### 2.4 シグナリング中の参加者切断処理テスト
- **テスト名**: シグナリング処理中の参加者切断時に適切な処理が行われる
  - **エラーケースの概要**: メッセージ中継中の送信者または宛先の突然切断
  - **エラー処理の重要性**: 孤立したシグナリングの適切な終了、リソース解放
- **入力値**: 宛先参加者切断状態でのofferメッセージ送信試行
  - **不正な理由**: ネットワーク切断、ブラウザクラッシュによる突然の切断
  - **実際の発生シナリオ**: シグナリング中のネットワーク障害、強制終了
- **期待される結果**: 切断検知、未配信通知、リソースクリーンアップ
  - **エラーメッセージの内容**: 宛先切断による配信失敗通知
  - **システムの安全性**: 孤立シグナリングの自動終了
- **テストの目的**: 切断時の自動処理機能確認
  - **品質保証の観点**: 障害耐性、自動回復機能
- 🟡 要件定義書の送信者切断ケース、Socket.IO切断処理に基づく

### 2.5 大量同時シグナリングでの過負荷エラー
- **テスト名**: 大量の同時シグナリングメッセージ処理時の適切な制限
  - **エラーケースの概要**: システム処理能力を超える大量シグナリング受信
  - **エラー処理の重要性**: システム安定性維持、サービス品質保証
- **入力値**: 短時間での大量ICE候補メッセージ（100件/秒）
  - **不正な理由**: 通常のWebRTC接続で発生しない異常な頻度
  - **実際の発生シナリオ**: 悪意のある攻撃、クライアント側バグによる無限送信
- **期待される結果**: レート制限適用、過負荷エラー応答
  - **エラーメッセージの内容**: レート制限超過を示すメッセージ
  - **システムの安全性**: システム保護、他参加者への影響最小化
- **テストの目的**: 過負荷保護機能の実効性確認
  - **品質保証の観点**: システム安定性、DoS攻撃防御
- 🟡 システム保護要件からの推測、負荷制限機能

## 3. 境界値テストケース（最小値、最大値、null等）

### 3.1 最大参加者数（10人）でのシグナリングテスト
- **テスト名**: 10人参加時のメッシュ型シグナリングが正常に処理される
  - **境界値の意味**: NFR-004要件の上限での複雑シグナリング処理
  - **境界値での動作保証**: 最大負荷時のシグナリング品質維持
- **入力値**: 10人参加状態での新規参加者（11人目前提）のシグナリング
  - **境界値選択の根拠**: NFR-004「最大10人同時参加」での最大シグナリング負荷
  - **実際の使用場面**: 満室での会議における複雑なWebRTC接続管理
- **期待される結果**: 全ペア間の正確なシグナリング、処理遅延なし
  - **境界での正確性**: メッセージルーティング精度、処理時間維持
  - **一貫した動作**: 参加者数に関わらないシグナリング品質
- **テストの目的**: 最大負荷時のシグナリング性能確認
  - **堅牢性の確認**: 複雑な接続構成での安定性、スケーラビリティ限界
- 🟢 NFR-004要件、architecture.mdのメッシュ型制限に基づく

### 3.2 最小シグナリングデータサイズテスト
- **テスト名**: 最小限のWebRTCシグナリングデータで正常に動作する
  - **境界値の意味**: WebRTC標準の最小必須データでの動作確認
  - **境界値での動作保証**: 最小データでの完全な機能実現
- **入力値**: 最小限のSDP offer（必須フィールドのみ）
  ```typescript
  {
    type: "offer",
    sdp: "v=0\r\no=- 0 0 IN IP4 0.0.0.0\r\ns=-\r\nt=0 0\r\n"
  }
  ```
  - **境界値選択の根拠**: WebRTC標準の最小必須SDP構造
  - **実際の使用場面**: 軽量クライアント、帯域制限環境でのシグナリング
- **期待される結果**: 最小データでの正常中継、データ完全性保持
  - **境界での正確性**: 最小データ処理、必須情報の確実な配信
  - **一貫した動作**: データサイズに関わらない処理品質
- **テストの目的**: 最小データ処理能力の確認
  - **堅牢性の確認**: データサイズ変動への対応、効率的な処理
- 🟡 WebRTC標準仕様の最小要件からの推測

### 3.3 最大シグナリングデータサイズテスト
- **テスト名**: 大容量のWebRTCシグナリングデータが正常に処理される
  - **境界値の意味**: 実用的な最大SDP/ICEデータサイズでの処理能力
  - **境界値での動作保証**: 大容量データでの安定した中継処理
- **入力値**: 大容量SDP offer（多数のcodec、candidate情報含む）
  - **境界値選択の根拠**: 実際のWebRTC接続で発生する最大級のSDP容量
  - **実際の使用場面**: 高品質音声設定、複数ネットワーク環境での接続
- **期待される結果**: 大容量データの完全な中継、タイムアウトなし
  - **境界での正確性**: 大容量データ処理、メモリ効率性
  - **一貫した動作**: データ容量に関わらない処理速度
- **テストの目的**: 大容量データ処理能力の確認
  - **堅牢性の確認**: メモリ管理、処理性能の上限確認
- 🟡 実用的WebRTC環境での最大データサイズからの推測

### 3.4 シグナリング処理時間境界値テスト
- **テスト名**: シグナリングメッセージ中継が即座に（100ms以内）完了する
  - **境界値の意味**: NFR-001音声遅延要件の前提となるシグナリング速度
  - **境界値での動作保証**: 低遅延要件を満たすシグナリング性能
- **入力値**: 高負荷状態（9人参加）でのシグナリングメッセージ
  - **境界値選択の根拠**: NFR-001「音声遅延200ms以内」のためのシグナリング高速化
  - **実際の使用場面**: リアルタイム通話でのWebRTC接続確立速度
- **期待される結果**: 100ms以内の中継完了、機能品質維持
  - **境界での正確性**: 処理時間測定、レスポンシブ性能
  - **一貫した動作**: 負荷状況に関わらない応答速度
- **テストの目的**: シグナリング性能要件の遵守確認
  - **堅牢性の確認**: 高負荷時でも低遅延シグナリングの実現
- 🟢 NFR-001要件、シグナリング遅延要件に基づく

### 3.5 null/undefined値でのシグナリングエラーテスト
- **テスト名**: null/undefined値を含むシグナリングデータで適切なエラーが返される
  - **境界値の意味**: 無効データでの防御機能、型安全性の実効性
  - **境界値での動作保証**: 不正データへの堅牢な対応
- **入力値**: null SDP、undefined参加者ID等の無効データ
  - **境界値選択の根拠**: TypeScript型定義の境界における安全性確認
  - **実際の使用場面**: クライアント側バグ、ネットワークデータ破損
- **期待される結果**: 適切なバリデーションエラー、中継拒否
  - **境界での正確性**: 型検証、データ完全性チェック
  - **一貫した動作**: 無効データの確実な検出と拒否
- **テストの目的**: データ検証機能の完全性確認
  - **堅牢性の確認**: 型安全性実現、不正データ防御
- 🟡 TypeScript型定義、データ検証要件からの堅牢性推測

## 品質判定

✅ **高品質**:
- テストケース分類: 正常系・異常系・境界値が網羅されている（6正常系・5異常系・5境界値）
- 期待値定義: 各テストケースの期待値が明確（WebRTCシグナリング、Socket.IOイベント、エラーハンドリング詳細）
- 技術選択: プログラミング言語・テストフレームワークが確定（TypeScript + Jest + Socket.IO Client + WebRTC Mock）
- 実装可能性: 現在の技術スタックで実現可能（TASK-102基盤上、WebRTC標準準拠）

## 次のステップ

次のおすすめステップ: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。