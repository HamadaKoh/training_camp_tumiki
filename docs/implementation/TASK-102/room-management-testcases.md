# TASK-102: ルーム管理機能実装 - TDDテストケース洗い出し

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: 型安全性による複雑な状態管理の安全性確保、Socket.IOとの親和性
  - **テストに適した機能**: インターフェース定義による明確なAPI契約、非同期処理のテスト支援
- **テストフレームワーク**: Jest + Socket.IO Client (テスト用)
  - **フレームワーク選択の理由**: Socket.IOイベントテストに最適、非同期処理・DB操作のモック対応
  - **テスト実行環境**: Docker環境でのPostgreSQL、Socket.IOテストクライアント、インメモリDB
- 🟢 既存プロジェクトの技術スタック（REQ-402, REQ-406）に準拠、TASK-101の基盤上に構築

## 1. 正常系テストケース（基本的な動作）

### 1.1 RoomManagerクラス初期化テスト
- **テスト名**: RoomManagerクラスが正常に初期化できる
  - **何をテストするか**: RoomManagerインスタンス生成と初期状態設定
  - **期待される動作**: 空の参加者マップ、デフォルトルーム設定の初期化
- **入力値**: デフォルト設定（maxParticipants: 10, roomId: "default-room"）
  - **入力データの意味**: MVP要件に準拠した単一ルーム構成
- **期待される結果**: 参加者数0、screenSharingParticipantId null、正常インスタンス
  - **期待結果の理由**: クリーンな初期状態からの状態管理開始
- **テストの目的**: ルーム管理基盤の正常性確認
  - **確認ポイント**: インスタンス生成、初期値設定、メモリ状態管理
- 🟢 要件定義書のRoomManagerクラス設計に基づく

### 1.2 単一参加者の入室テスト
- **テスト名**: 1人の参加者が正常にルームに参加できる
  - **何をテストするか**: addParticipant メソッドによる参加者追加処理
  - **期待される動作**: 参加者ID生成、参加者マップ更新、DB記録、イベント通知
- **入力値**: Socket ID "socket-123"
  - **入力データの意味**: Socket.IO接続時に生成される一意識別子
- **期待される結果**: 
  ```typescript
  {
    success: true,
    participant: {
      id: "uuid-v4",
      socketId: "socket-123",
      joinedAt: Date,
      isMuted: false,
      isSharingScreen: false,
      connectionQuality: "good"
    },
    participants: [participant]
  }
  ```
  - **期待結果の理由**: interfaces.ts仕様に準拠した構造化レスポンス
- **テストの目的**: 基本的な参加者管理機能の動作確認
  - **確認ポイント**: UUID生成、状態管理、DB記録、イベント配信
- 🟢 要件定義書の正常参加フローに基づく

### 1.3 複数参加者の入室テスト
- **テスト名**: 複数参加者が順次ルームに参加できる
  - **何をテストするか**: 複数のaddParticipant呼び出しによる状態管理
  - **期待される動作**: 各参加者の独立した状態管理、参加者リスト正確な更新
- **入力値**: 3つのSocket ID ["socket-1", "socket-2", "socket-3"]
  - **入力データの意味**: 通常の通話開始時の参加者増加パターン
- **期待される結果**: 3人の参加者リスト、各参加者の一意なID、全員への通知
  - **期待結果の理由**: REQ-004（参加者リスト表示）要件の実現
- **テストの目的**: 多人数での状態管理正確性確認
  - **確認ポイント**: 状態の独立性、リスト整合性、通知の全配信
- 🟢 REQ-004（参加者リスト表示）、REQ-102（入室通知）要件に基づく

### 1.4 参加者の正常退出テスト
- **テスト名**: 参加者が正常にルームから退出できる
  - **何をテストするか**: removeParticipant メソッドによる参加者削除処理
  - **期待される動作**: 参加者マップ更新、DB記録、残りメンバーへの通知
- **入力値**: 既存の参加者ID "participant-123"
  - **入力データの意味**: 実際の退出要求またはSocket.IO切断による識別子
- **期待される結果**: 参加者リストから削除、left_at タイムスタンプ記録、user-leftイベント
  - **期待結果の理由**: REQ-103（退出通知）要件とDB永続化要件
- **テストの目的**: 退出処理の完全性確認
  - **確認ポイント**: 状態削除、DB更新、残存参加者への通知
- 🟢 要件定義書の正常退出フロー、REQ-103要件に基づく

### 1.5 データベースセッション記録テスト
- **テスト名**: 参加者の入退室がデータベースに正確に記録される
  - **何をテストするか**: sessions テーブルとevent_logs テーブルへの記録処理
  - **期待される動作**: 参加時・退出時の完全なログ記録、トランザクション整合性
- **入力値**: 参加者の入室→退出の一連の流れ
  - **入力データの意味**: 実際のユーザー行動パターンの記録要件
- **期待される結果**: sessionsレコード（joined_at, left_at）、event_logsレコード（join_room, leave_room）
  - **期待結果の理由**: database-schema.sql設計と監査要件
- **テストの目的**: データ永続化の完全性確認
  - **確認ポイント**: トランザクション整合性、記録の完全性、タイムスタンプ精度
- 🟢 database-schema.sql仕様、トランザクション要件に基づく

### 1.6 参加者リスト同期テスト
- **テスト名**: 新規参加者に既存参加者リストが正確に提供される
  - **何をテストするか**: join-room時の既存参加者情報同期機能
  - **期待される動作**: 新規参加者への完全な参加者リスト配信
- **入力値**: 既に2人参加済みの状態での3人目の参加
  - **入力データの意味**: 途中参加時の状態同期要件
- **期待される結果**: 3人目に2人の既存参加者情報を含む完全なリスト提供
  - **期待結果の理由**: REQ-004（参加者リスト表示）の完全実装
- **テストの目的**: 状態同期機能の正確性確認
  - **確認ポイント**: リスト完全性、状態一貫性、タイミング正確性
- 🟢 REQ-004要件、参加者リスト同期要件に基づく

## 2. 異常系テストケース（エラーハンドリング）

### 2.1 ルーム満員時の参加拒否テスト
- **テスト名**: 10人参加後の11人目参加時にROOM_FULLエラーが返される
  - **エラーケースの概要**: 参加者上限超過時の適切な拒否処理
  - **エラー処理の重要性**: システム負荷制限とサービス品質維持
- **入力値**: 10人参加済み状態での11番目のSocket ID
  - **不正な理由**: NFR-004要件の上限超過
  - **実際の発生シナリオ**: 人気時間帯での満室ルームへの参加試行
- **期待される結果**: 
  ```typescript
  {
    success: false,
    error: {
      code: "ROOM_FULL",
      message: "ルームが満員です"
    }
  }
  ```
  - **エラーメッセージの内容**: ユーザーフレンドリーな日本語メッセージ
  - **システムの安全性**: 既存10人の接続に影響なし、リソース保護
- **テストの目的**: 容量制限機能の実効性確認
  - **品質保証の観点**: システム安定性、公平なアクセス機会提供
- 🟢 EDGE-102要件、NFR-004上限超過ケースに基づく

### 2.2 データベース接続エラー時の処理テスト
- **テスト名**: DB接続失敗時に参加処理がロールバックされる
  - **エラーケースの概要**: データベース障害時の状態整合性保護
  - **エラー処理の重要性**: データ不整合防止、システム信頼性維持
- **入力値**: DB接続不可状態での参加リクエスト
  - **不正な理由**: インフラ障害、ネットワーク問題
  - **実際の発生シナリオ**: DB メンテナンス、ネットワーク分断、高負荷時
- **期待される結果**: 参加処理失敗、インメモリ状態変更なし、エラー応答
  - **エラーメッセージの内容**: 一時的な障害を示すメッセージ
  - **システムの安全性**: 部分的な状態変更の回避、整合性維持
- **テストの目的**: トランザクション整合性の確認
  - **品質保証の観点**: データ整合性、障害時の安全な動作
- 🟡 要件定義書のDB接続エラーケース、アトミック処理要件に基づく

### 2.3 重複Socket ID参加試行テスト
- **テスト名**: 既存Socket IDでの再参加試行が適切に処理される
  - **エラーケースの概要**: 同一Socket IDでの重複参加防止
  - **エラー処理の重要性**: 状態管理の整合性、リソース重複使用防止
- **入力値**: 既に参加済みのSocket ID "socket-123"
  - **不正な理由**: 同一接続での重複登録
  - **実際の発生シナリオ**: クライアント側バグ、ネットワーク問題による重複送信
- **期待される結果**: 既存参加者情報返却、新規登録なし、状態不変
  - **エラーメッセージの内容**: 既に参加済みを示すメッセージ
  - **システムの安全性**: 重複状態の回避、既存接続の保護
- **テストの目的**: 重複参加制御の確認
  - **品質保証の観点**: 状態管理の一意性、リソース効率性
- 🟡 要件定義書の重複参加制御要件に基づく

### 2.4 存在しない参加者の退出試行テスト
- **テスト名**: 存在しない参加者IDでの退出時に適切なエラーが返される
  - **エラーケースの概要**: 無効な参加者IDでの退出処理
  - **エラー処理の重要性**: 不正な操作の防止、状態管理の整合性保護
- **入力値**: 存在しない参加者ID "nonexistent-participant"
  - **不正な理由**: 既に退出済み、または無効なID
  - **実際の発生シナリオ**: ネットワーク遅延による重複退出、クライアント側バグ
- **期待される結果**: 参加者未発見エラー、状態変更なし
  - **エラーメッセージの内容**: 参加者が見つからない旨のメッセージ
  - **システムの安全性**: 不正な状態変更の防止
- **テストの目的**: 不正操作への防御機能確認
  - **品質保証の観点**: 堅牢性、不正入力への対応
- 🟡 堅牢性要件からの推測、エラーハンドリング要件

### 2.5 Socket.IO切断時の自動退出処理テスト
- **テスト名**: Socket.IO切断時に参加者が自動的に退出処理される
  - **エラーケースの概要**: ネットワーク切断時の自動クリーンアップ
  - **エラー処理の重要性**: 孤立状態の防止、リソース適切な解放
- **入力値**: 参加中のSocket.IO接続の突然切断
  - **不正な理由**: ネットワーク障害、ブラウザクラッシュ、電源断
  - **実際の発生シナリオ**: モバイル通信切断、PC電源断、ブラウザ強制終了
- **期待される結果**: 自動退出処理、DB記録、他参加者への通知
  - **エラーメッセージの内容**: 参加者の予期しない退出通知
  - **システムの安全性**: 孤立参加者の自動削除、状態整合性維持
- **テストの目的**: 自動クリーンアップ機能の確認
  - **品質保証の観点**: 障害耐性、自動回復機能
- 🟡 要件定義書の突然の切断ケース、Socket.IO仕様に基づく

## 3. 境界値テストケース（最小値、最大値、null等）

### 3.1 最大参加者数（10人）での正常動作テスト
- **テスト名**: 正確に10人の参加者で全機能が正常動作する
  - **境界値の意味**: NFR-004要件の設計上限値での動作検証
  - **境界値での動作保証**: システム最大容量での安定稼働
- **入力値**: 10人の同時参加者
  - **境界値選択の根拠**: NFR-004「最大10人の同時参加サポート」
  - **実際の使用場面**: 満室での会議・プレゼンテーション
- **期待される結果**: 全10人の状態管理、正確なリスト管理、パフォーマンス維持
  - **境界での正確性**: メモリ使用量、処理時間、通知配信の効率性
  - **一貫した動作**: 1人時と10人時の機能品質一貫性
- **テストの目的**: 設計容量での機能完全性確認
  - **堅牢性の確認**: 最大負荷での安定性、レスポンス時間維持
- 🟢 NFR-004要件「最大10人の同時参加サポート」に基づく

### 3.2 参加者0人から1人への遷移テスト
- **テスト名**: 空ルームへの最初の参加者が正常に処理される
  - **境界値の意味**: 最小参加者数（0→1）での状態遷移
  - **境界値での動作保証**: 初期状態からの正確な状態管理開始
- **入力値**: 空ルーム状態での初回参加者
  - **境界値選択の根拠**: システム初期状態からの状態遷移
  - **実際の使用場面**: 会議開始時の最初の参加者
- **期待される結果**: 初期参加者の正確な登録、状態管理開始、DB記録
  - **境界での正確性**: 初期化処理、状態遷移、記録開始
  - **一貫した動作**: 空から1人への状態変更の確実性
- **テストの目的**: 初期状態遷移の正確性確認
  - **堅牢性の確認**: 初期化処理の完全性、エッジケース対応
- 🟡 状態管理の最小境界からの推測

### 3.3 最後の参加者退出時の状態クリアテスト
- **テスト名**: 最後の参加者退出時にルーム状態が適切にクリアされる
  - **境界値の意味**: 参加者数の最小値（1→0）での状態管理
  - **境界値での動作保証**: 空ルーム状態への適切な遷移
- **入力値**: 1人のみの状態からの退出
  - **境界値選択の根拠**: 参加者数下限での状態管理
  - **実際の使用場面**: 会議終了時の最後の参加者
- **期待される結果**: 空ルーム状態復帰、画面共有状態クリア、適切なDB記録
  - **境界での正確性**: 状態リセット、リソース解放、記録完了
  - **一貫した動作**: 1人から0人への確実な状態遷移
- **テストの目的**: 最終状態遷移の完全性確認
  - **堅牢性の確認**: リソース解放、状態初期化の確実性
- 🟡 状態管理の境界値からの推測

### 3.4 処理時間境界値（1秒以内）テスト
- **テスト名**: 参加・退出処理が1秒以内に完了する
  - **境界値の意味**: NFR-003要件の応答時間上限での性能検証
  - **境界値での動作保証**: パフォーマンス要件の遵守
- **入力値**: 高負荷状態（9人参加済み）での参加・退出処理
  - **境界値選択の根拠**: NFR-003「1秒以内に完了」要件
  - **実際の使用場面**: 満室近い状態での頻繁な入退室
- **期待される結果**: 1000ms以内の処理完了、機能品質維持
  - **境界での正確性**: 処理時間測定、機能完全性保持
  - **一貫した動作**: 負荷状況に関わらない応答品質
- **テストの目的**: パフォーマンス要件の遵守確認
  - **堅牢性の確認**: 高負荷時でも要求仕様の維持
- 🟢 NFR-003要件「1秒以内に完了」に基づく

### 3.5 null/undefined値でのエラーハンドリングテスト
- **テスト名**: null/undefined入力値に対して適切なエラーが返される
  - **境界値の意味**: 無効入力値での防御機能検証
  - **境界値での動作保証**: 不正入力への堅牢な対応
- **入力値**: null Socket ID、undefined参加者ID
  - **境界値選択の根拠**: TypeScript型安全性の実効性確認
  - **実際の使用場面**: クライアント側バグ、不正なAPI呼び出し
- **期待される結果**: 適切なバリデーションエラー、状態変更なし
  - **境界での正確性**: 入力検証、エラーメッセージ品質
  - **一貫した動作**: 無効入力の確実な拒否
- **テストの目的**: 入力検証機能の完全性確認
  - **堅牢性の確認**: 不正入力への防御、型安全性実現
- 🟡 TypeScript型定義からの堅牢性推測

## 品質判定

✅ **高品質**:
- テストケース分類: 正常系・異常系・境界値が網羅されている（6正常系・5異常系・5境界値）
- 期待値定義: 各テストケースの期待値が明確（Socket.IOイベント、DB記録、状態管理）
- 技術選択: プログラミング言語・テストフレームワークが確定（TypeScript + Jest + Socket.IO Client）
- 実装可能性: 現在の技術スタックで実現可能（TASK-101基盤上、RoomManager状態管理）

## 次のステップ

次のおすすめステップ: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。