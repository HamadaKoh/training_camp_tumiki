# TASK-302: 音声制御機能実装 - テストケース定義

## 概要

音声制御機能のテストケースを定義する。ミュート/ミュート解除、音声トラック制御、状態同期のテストを含む。

## テスト環境

- Testing Framework: Vitest
- DOM Testing: @testing-library/react
- WebRTC Mocking: Manual mocks
- Audio Mocking: MediaStreamTrack mocks

## 1. useAudioControls フック 単体テスト

### 1.1 初期化テスト

#### Test Case: AUDIO-001
- **テスト名**: useAudioControls初期化
- **入力**: なし
- **期待結果**: 初期状態が正しく設定される
- **検証項目**:
  - isMuted が false
  - isLoading が false
  - participantMuteStates が空のオブジェクト

#### Test Case: AUDIO-002
- **テスト名**: WebRTC統合確認
- **前提条件**: useWebRTCフックが利用可能
- **期待結果**: WebRTC連携が初期化される
- **検証項目**:
  - useWebRTC が呼び出される
  - localStream が取得される

### 1.2 ミュート制御テスト

#### Test Case: AUDIO-003
- **テスト名**: ミュート切り替え
- **操作**: toggleMute() 実行
- **期待結果**: ミュート状態が切り替わる
- **検証項目**:
  - isMuted が true になる
  - 音声トラックのenabled が false になる
  - Socket.IOイベントが送信される

#### Test Case: AUDIO-004
- **テスト名**: ミュート解除
- **前提条件**: ミュート状態
- **操作**: toggleMute() 実行
- **期待結果**: ミュート解除される
- **検証項目**:
  - isMuted が false になる
  - 音声トラックのenabled が true になる
  - Socket.IOイベントが送信される

#### Test Case: AUDIO-005
- **テスト名**: 直接ミュート設定
- **操作**: setMuted(true) 実行
- **期待結果**: ミュート状態に設定される
- **検証項目**:
  - isMuted が true になる
  - 状態変更が通知される

#### Test Case: AUDIO-006
- **テスト名**: 直接ミュート解除設定
- **操作**: setMuted(false) 実行
- **期待結果**: ミュート解除状態に設定される
- **検証項目**:
  - isMuted が false になる
  - 状態変更が通知される

### 1.3 ローディング状態テスト

#### Test Case: AUDIO-007
- **テスト名**: ミュート操作中のローディング
- **操作**: toggleMute() 実行中
- **期待結果**: ローディング状態が管理される
- **検証項目**:
  - isLoading が true になる
  - 操作完了後に false になる

#### Test Case: AUDIO-008
- **テスト名**: 同時操作の防止
- **操作**: ローディング中に再度 toggleMute() 実行
- **期待結果**: 2回目の操作が無視される
- **検証項目**:
  - 重複操作が実行されない
  - エラーが発生しない

### 1.4 参加者状態管理テスト

#### Test Case: AUDIO-009
- **テスト名**: 参加者ミュート状態更新
- **操作**: Socket.IOで参加者ミュート状態受信
- **期待結果**: 参加者状態が更新される
- **検証項目**:
  - participantMuteStates が更新される
  - 該当参加者の状態が正確に反映される

#### Test Case: AUDIO-010
- **テスト名**: 複数参加者状態管理
- **操作**: 複数参加者のミュート状態変更
- **期待結果**: 各参加者の状態が独立管理される
- **検証項目**:
  - 個別参加者状態が正確
  - 他参加者への影響なし

## 2. 音声トラック制御テスト

### 2.1 音声トラック操作テスト

#### Test Case: TRACK-001
- **テスト名**: 音声トラック取得
- **前提条件**: MediaStream が存在
- **期待結果**: 音声トラックが取得される
- **検証項目**:
  - getAudioTracks() が呼ばれる
  - 有効な音声トラックが返される

#### Test Case: TRACK-002
- **テスト名**: 音声トラック有効化
- **操作**: 音声トラック.enabled = true
- **期待結果**: 音声が有効になる
- **検証項目**:
  - track.enabled が true
  - 音声が出力される

#### Test Case: TRACK-003
- **テスト名**: 音声トラック無効化
- **操作**: 音声トラック.enabled = false
- **期待結果**: 音声が無効になる
- **検証項目**:
  - track.enabled が false
  - 音声が出力されない

#### Test Case: TRACK-004
- **テスト名**: 音声トラック未存在時の処理
- **前提条件**: 音声トラックなし
- **操作**: ミュート操作実行
- **期待結果**: エラーが適切に処理される
- **検証項目**:
  - エラーが発生する
  - アプリケーションがクラッシュしない

### 2.2 音声品質制御テスト

#### Test Case: QUALITY-001
- **テスト名**: 音声品質設定
- **操作**: setAudioQuality('high') 実行
- **期待結果**: 音声品質が更新される
- **検証項目**:
  - 音声制約が更新される
  - Socket.IOイベントが送信される

#### Test Case: QUALITY-002
- **テスト名**: 無効な品質設定
- **操作**: setAudioQuality('invalid') 実行
- **期待結果**: エラーが処理される
- **検証項目**:
  - エラーメッセージが表示される
  - 現在の設定が維持される

## 3. Socket.IO統合テスト

### 3.1 送信イベントテスト

#### Test Case: SOCKET-001
- **テスト名**: ミュート状態変更通知
- **操作**: toggleMute() 実行
- **期待結果**: Socket.IOイベントが送信される
- **検証項目**:
  - 'audio-mute-changed' イベント送信
  - 正確なデータ形式
  - タイムスタンプ含有

#### Test Case: SOCKET-002
- **テスト名**: 音声品質変更通知
- **操作**: setAudioQuality() 実行
- **期待結果**: Socket.IOイベントが送信される
- **検証項目**:
  - 'audio-quality-changed' イベント送信
  - 品質設定が正確

### 3.2 受信イベントテスト

#### Test Case: SOCKET-003
- **テスト名**: 参加者ミュート状態受信
- **操作**: 'participant-mute-changed' イベント受信
- **期待結果**: 参加者状態が更新される
- **検証項目**:
  - participantMuteStates が更新される
  - UI が再描画される

#### Test Case: SOCKET-004
- **テスト名**: 参加者リスト更新受信
- **操作**: 'participants-updated' イベント受信
- **期待結果**: 全参加者状態が更新される
- **検証項目**:
  - 全参加者のミュート状態が反映
  - 不要な参加者が削除される

## 4. エラーハンドリングテスト

### 4.1 音声デバイスエラー

#### Test Case: ERROR-001
- **テスト名**: 音声デバイス使用中エラー
- **前提条件**: 他アプリが音声デバイス使用中
- **操作**: ミュート解除試行
- **期待結果**: エラーが適切に処理される
- **検証項目**:
  - エラーメッセージが表示される
  - 状態が一貫性を保つ

#### Test Case: ERROR-002
- **テスト名**: 音声権限拒否エラー
- **前提条件**: 音声権限なし
- **操作**: ミュート解除試行
- **期待結果**: 権限エラーが処理される
- **検証項目**:
  - 権限要求が表示される
  - フォールバック処理

### 4.2 WebRTC統合エラー

#### Test Case: ERROR-003
- **テスト名**: PeerConnection未初期化エラー
- **前提条件**: WebRTC未初期化
- **操作**: ミュート操作実行
- **期待結果**: エラーが適切に処理される
- **検証項目**:
  - エラー処理が実行される
  - 初期化の促しが表示される

#### Test Case: ERROR-004
- **テスト名**: 音声トラック制御失敗
- **前提条件**: 無効な音声トラック
- **操作**: トラック制御実行
- **期待結果**: 失敗が適切に処理される
- **検証項目**:
  - エラーログが出力される
  - リトライ機能が動作

### 4.3 Socket.IO通信エラー

#### Test Case: ERROR-005
- **テスト名**: Socket.IO切断エラー
- **前提条件**: Socket.IO切断状態
- **操作**: ミュート状態変更
- **期待結果**: ローカル状態は更新され、再接続時に同期
- **検証項目**:
  - ローカル状態変更
  - 再接続時の状態同期

#### Test Case: ERROR-006
- **テスト名**: イベント送信失敗
- **前提条件**: ネットワークエラー
- **操作**: 状態変更通知送信
- **期待結果**: リトライ処理が動作
- **検証項目**:
  - 自動リトライ実行
  - ユーザーへの通知

## 5. パフォーマンステスト

### 5.1 応答速度テスト

#### Test Case: PERF-001
- **テスト名**: ミュート切り替え応答時間
- **操作**: toggleMute() 実行
- **期待結果**: 100ms以内で完了
- **検証項目**:
  - 実行時間測定
  - UI更新タイミング

#### Test Case: PERF-002
- **テスト名**: UI反映速度
- **操作**: 状態変更実行
- **期待結果**: 50ms以内でUI更新
- **検証項目**:
  - レンダリング時間測定
  - ユーザー体験確認

### 5.2 リソース効率テスト

#### Test Case: PERF-003
- **テスト名**: メモリリークチェック
- **操作**: ミュート切り替えを100回繰り返し
- **期待結果**: メモリ使用量が増加しない
- **検証項目**:
  - メモリ使用量監視
  - イベントリスナー適切削除

#### Test Case: PERF-004
- **テスト名**: 不要な通信防止
- **操作**: 同じ状態への変更を複数回実行
- **期待結果**: 重複通信が発生しない
- **検証項目**:
  - Socket.IOイベント送信回数
  - 状態変更の最適化

## 6. UI統合テスト

### 6.1 ミュートボタンテスト

#### Test Case: UI-001
- **テスト名**: ミュートボタン表示
- **前提条件**: コンポーネント描画
- **期待結果**: ミュートボタンが表示される
- **検証項目**:
  - ボタン要素の存在
  - 適切なアイコン表示

#### Test Case: UI-002
- **テスト名**: ミュートボタンクリック
- **操作**: ミュートボタンクリック
- **期待結果**: ミュート状態が切り替わる
- **検証項目**:
  - toggleMute が呼ばれる
  - UI状態が更新される

#### Test Case: UI-003
- **テスト名**: 視覚的フィードバック
- **操作**: ミュート状態変更
- **期待結果**: ボタンの見た目が変わる
- **検証項目**:
  - アイコンの変更
  - 色やスタイルの変更

### 6.2 アニメーションテスト

#### Test Case: UI-004
- **テスト名**: トグル時のアニメーション
- **操作**: ミュート切り替え
- **期待結果**: スムーズなアニメーション
- **検証項目**:
  - アニメーション実行
  - 200ms以下の所要時間

#### Test Case: UI-005
- **テスト名**: ローディング時のスピナー
- **操作**: 処理中状態
- **期待結果**: ロードスピナーが表示
- **検証項目**:
  - スピナー要素の表示
  - 処理完了後の非表示

## 7. アクセシビリティテスト

### 7.1 キーボード操作テスト

#### Test Case: ALLY-001
- **テスト名**: キーボードフォーカス
- **操作**: Tab キーでナビゲーション
- **期待結果**: ミュートボタンにフォーカス可能
- **検証項目**:
  - フォーカス表示
  - フォーカスリング表示

#### Test Case: ALLY-002
- **テスト名**: キーボードでのミュート切り替え
- **操作**: スペースキー押下
- **期待結果**: ミュート状態が切り替わる
- **検証項目**:
  - キーボードイベント処理
  - 機能の動作

### 7.2 スクリーンリーダー対応テスト

#### Test Case: ALLY-003
- **テスト名**: aria-label 設定
- **前提条件**: ミュートボタン表示
- **期待結果**: 適切なラベルが設定される
- **検証項目**:
  - aria-label 属性存在
  - 状態に応じたラベル変更

#### Test Case: ALLY-004
- **テスト名**: 状態変更の音声通知
- **操作**: ミュート状態変更
- **期待結果**: スクリーンリーダーが状態を読み上げ
- **検証項目**:
  - aria-live 設定
  - 状態変更通知

## テスト実行計画

### Phase 1: 単体テスト (15分)
- useAudioControls フック テスト
- 音声トラック制御テスト

### Phase 2: 統合テスト (10分)
- Socket.IO統合テスト
- WebRTC統合テスト

### Phase 3: UI・エラーテスト (5分)
- UI統合テスト
- 主要エラーケースのみ

## Mock設定

### Audio Track Mock
```typescript
const mockAudioTrack = {
  enabled: true,
  kind: 'audio',
  stop: vi.fn(),
  addEventListener: vi.fn(),
  removeEventListener: vi.fn()
}

const mockMediaStream = {
  getAudioTracks: vi.fn(() => [mockAudioTrack])
}
```

### Socket.IO Mock
```typescript
const mockSocket = {
  emit: vi.fn(),
  on: vi.fn(),
  off: vi.fn()
}
```

## 成功基準

1. **全単体テストが通る** (95%以上)
2. **統合テストが通る** (主要シナリオ)
3. **エラーハンドリングが動作** (基本ケース)
4. **パフォーマンス要件を満たす** (応答時間)
5. **アクセシビリティ基準クリア** (基本項目)