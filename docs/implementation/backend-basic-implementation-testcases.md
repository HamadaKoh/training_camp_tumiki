# TDDテストケース一覧 - TASK-101: バックエンド基本実装

**【機能名】**: backend-basic-implementation (TASK-101)  
**【対象技術】**: TypeScript + Express.js + PostgreSQL  
**【テストフレームワーク】**: Jest + Supertest

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: 要件REQ-403でTypeScript実装が明記されており、型安全性によりテストの信頼性が向上
  - **テストに適した機能**: 型定義による静的チェック、インターフェースによる契約の明確化
- **テストフレームワーク**: Jest + Supertest
  - **フレームワーク選択の理由**: Node.js/Express環境でのHTTP APIテストに標準的で、非同期処理テストに優れている
  - **テスト実行環境**: Node.js 18+、TypeScript環境、テスト用PostgreSQLデータベース
- 🟢 **青信号**: 要件定義書とarchitecture.mdで明確に指定された技術スタック

---

## 1. 正常系テストケース（基本的な動作）

### 1.1 サーバー起動テスト

- **テスト名**: Expressサーバーが正常に起動する
  - **何をテストするか**: Express.jsアプリケーションが指定ポートで正常に起動し、HTTPリクエストを受け付ける状態になること
  - **期待される動作**: サーバーが起動し、指定ポート（デフォルト:3000）でリスニング状態になる
- **入力値**: 環境変数 `PORT=3000`, `NODE_ENV=test`
  - **入力データの意味**: テスト環境での標準的なポート設定、本番環境と分離したテスト実行環境
- **期待される結果**: サーバーが起動し、ポート3000でリスニング開始
  - **期待結果の理由**: バックエンドAPIとして機能するための前提条件が満たされる
- **テストの目的**: アプリケーション基盤の動作確認
  - **確認ポイント**: Express.jsの基本設定が正しく、サーバーが安定起動すること
- 🟢 **青信号**: 要件定義書の基本的な使用パターンで明記

### 1.2 ヘルスチェックエンドポイント（正常時）

- **テスト名**: GET /api/health で正常なヘルスチェックレスポンスを返す
  - **何をテストするか**: データベース接続が正常な状態でのヘルスチェックエンドポイントの動作
  - **期待される動作**: HTTP 200ステータスと正しい形式のHealthCheckResponseを返す
- **入力値**: `GET /api/health` HTTPリクエスト
  - **入力データの意味**: システム監視やロードバランサーからの定期的なヘルスチェック要求を模擬
- **期待される結果**: 
  ```json
  {
    "status": "healthy",
    "version": "1.0.0",
    "uptime": [正の数値],
    "checks": {
      "database": true,
      "kubernetes": false
    }
  }
  ```
  - **期待結果の理由**: interfaces.tsで定義されたHealthCheckResponse型に準拠し、システムが正常稼働していることを示す
- **テストの目的**: ヘルスチェック機能の正常動作確認
  - **確認ポイント**: レスポンス形式がTypeScript型定義に準拠し、データベース接続状態が正確に反映されること
- 🟢 **青信号**: interfaces.tsのHealthCheckResponse型定義とapi-endpoints.mdの仕様に基づく

### 1.3 データベース接続テスト

- **テスト名**: PostgreSQLデータベースに正常に接続できる
  - **何をテストするか**: データベース接続プールの初期化と基本的な接続動作
  - **期待される動作**: PostgreSQLへの接続が確立され、基本的なクエリが実行可能
- **入力値**: 有効な `DATABASE_URL` 環境変数
  - **入力データの意味**: 実際のデータベース接続に必要な正当な認証情報
- **期待される結果**: データベース接続成功、接続プールが利用可能状態
  - **期待結果の理由**: 将来の負荷データ保存機能で必要なデータベース接続基盤が確立される
- **テストの目的**: データベース基盤の動作確認
  - **確認ポイント**: 接続プール設定（最大10接続）が正しく動作し、接続が安定していること
- 🟢 **青信号**: database-schema.sqlとarchitecture.mdの接続設定に基づく

### 1.4 CORSヘッダー設定テスト

- **テスト名**: APIレスポンスに適切なCORSヘッダーが設定される
  - **何をテストするか**: フロントエンドからのクロスオリジンリクエストを許可するCORS設定
  - **期待される動作**: HTTPレスポンスに適切なCORSヘッダーが含まれる
- **入力値**: Origin付きのHTTPリクエスト
  - **入力データの意味**: ブラウザからのクロスオリジンリクエストを模擬
- **期待される結果**: `Access-Control-Allow-Origin` 等のCORSヘッダーが適切に設定
  - **期待結果の理由**: NFR-101の基本的なCORS設定要件を満たし、フロントエンドとの通信を可能にする
- **テストの目的**: セキュリティ設定の確認
  - **確認ポイント**: 必要最小限のCORSポリシーが設定され、不適切なオリジンからのアクセスは制限されること
- 🟢 **青信号**: NFR-101要件とapi-endpoints.mdのCORS設定に基づく

### 1.5 セキュリティヘッダー設定テスト

- **テスト名**: APIレスポンスに基本的なセキュリティヘッダーが設定される
  - **何をテストするか**: Helmet.jsによる基本的なセキュリティヘッダーの設定
  - **期待される動作**: HTTPレスポンスにセキュリティヘッダーが含まれる
- **入力値**: 任意のHTTPリクエスト
  - **入力データの意味**: 一般的なWebブラウザからのHTTPリクエスト
- **期待される結果**: `X-Content-Type-Options`, `X-Frame-Options` 等のセキュリティヘッダーが設定
  - **期待結果の理由**: 基本的なWebセキュリティ対策が実装され、XSS等の攻撃を軽減する
- **テストの目的**: セキュリティ基盤の確認
  - **確認ポイント**: 標準的なセキュリティヘッダーが適切に設定されていること
- 🟢 **青信号**: 要件定義書のセキュリティ要件とapi-endpoints.mdの仕様に基づく

---

## 2. 異常系テストケース（エラーハンドリング）

### 2.1 データベース接続失敗時のヘルスチェック

- **テスト名**: データベース接続失敗時にunhealthyステータスを返す
  - **エラーケースの概要**: データベースが利用不可能な状態でのヘルスチェック要求
  - **エラー処理の重要性**: システム監視とトラブル診断のための正確な状態報告が必要
- **入力値**: 無効な `DATABASE_URL` または接続不可能なデータベース
  - **不正な理由**: データベースサーバーの停止やネットワーク障害等の実運用で発生する障害
  - **実際の発生シナリオ**: データベースメンテナンス時、接続数上限到達時、ネットワーク分断時
- **期待される結果**: 
  ```json
  {
    "status": "unhealthy",
    "checks": {
      "database": false,
      "kubernetes": false
    }
  }
  ```
  - **エラーメッセージの内容**: データベース接続状態が正確に反映され、障害箇所が特定可能
  - **システムの安全性**: アプリケーションはクラッシュせず、適切なエラー状態を報告
- **テストの目的**: 障害時の適切なエラーハンドリング確認
  - **品質保証の観点**: 運用時の障害検知と診断を可能にし、システムの可観測性を確保
- 🟢 **青信号**: EDGE-001要件と入出力仕様の異常時の動作定義に基づく

### 2.2 存在しないエンドポイントアクセス（404エラー）

- **テスト名**: 存在しないエンドポイントに対して404エラーを返す
  - **エラーケースの概要**: 定義されていないURLパスへのHTTPリクエスト
  - **エラー処理の重要性**: 不正なアクセスや設定ミスを適切に検出し、攻撃の可能性を軽減
- **入力値**: `GET /api/nonexistent` などの未定義エンドポイント
  - **不正な理由**: APIの仕様書に存在しないエンドポイントへのアクセス
  - **実際の発生シナリオ**: フロントエンドの実装ミス、URL直接入力、外部からの探索的アクセス
- **期待される結果**: HTTP 404 Not Foundステータス
  - **エラーメッセージの内容**: 明確で一貫した404エラーレスポンス
  - **システムの安全性**: 情報漏洩を防ぎ、標準的なHTTPステータスで応答
- **テストの目的**: ルーティングエラーの適切な処理確認
  - **品質保証の観点**: APIの堅牢性とセキュリティを確保し、攻撃者への情報提供を最小化
- 🟢 **青信号**: 要件定義書のエラーケースとapi-endpoints.mdのHTTPステータスコード仕様に基づく

### 2.3 サーバー内部エラーハンドリング

- **テスト名**: 予期しないサーバーエラー時に500エラーを返す
  - **エラーケースの概要**: アプリケーション内部での予期しない例外やエラー
  - **エラー処理の重要性**: システムクラッシュを防ぎ、適切なエラーレスポンスでクライアントに通知
- **入力値**: エラーを引き起こす不正な処理を模擬
  - **不正な理由**: プログラムのバグや想定外の実行時エラー
  - **実際の発生シナリオ**: メモリ不足、ファイル読み込み失敗、ライブラリの予期しない動作
- **期待される結果**: HTTP 500 Internal Server Errorステータス
  - **エラーメッセージの内容**: 詳細すぎない一般的なエラーメッセージ（セキュリティ考慮）
  - **システムの安全性**: エラー詳細を隠蔽し、システムは継続動作可能
- **テストの目的**: 全般的なエラーハンドリングミドルウェアの確認
  - **品質保証の観点**: システムの耐障害性を確保し、予期しない障害からの適切な回復
- 🟡 **黄信号**: EDGE-002要件から派生した妥当な推測

---

## 3. 境界値テストケース（最小値、最大値、null等）

### 3.1 ポート設定の境界値テスト

- **テスト名**: 有効なポート範囲でのサーバー起動確認
  - **境界値の意味**: HTTPサーバーとして利用可能なポート番号の範囲確認
  - **境界値での動作保証**: 様々なポート設定でも安定したサーバー起動を確保
- **入力値**: PORT=1024（最小有効ポート）, PORT=65535（最大ポート）
  - **境界値選択の根拠**: 一般ユーザーが利用可能なポート範囲の境界値
  - **実際の使用場面**: 開発環境、テスト環境、本番環境での異なるポート設定
- **期待される結果**: 両方のポート設定でサーバーが正常起動
  - **境界での正確性**: 指定されたポートで正確にリスニング開始
  - **一貫した動作**: ポート番号に関係なく同一の機能が提供される
- **テストの目的**: 環境設定の柔軟性確認
  - **堅牢性の確認**: 様々なデプロイ環境でも安定動作することを保証
- 🟡 **黄信号**: 要件定義書のポート設定から派生した妥当な推測

### 3.2 ヘルスチェックレスポンス時間の境界値テスト

- **テスト名**: ヘルスチェックが500ms以内に応答する
  - **境界値の意味**: NFR-002で要求されるレスポンス時間の上限値
  - **境界値での動作保証**: パフォーマンス要件を満たした応答速度の確保
- **入力値**: 複数回の`GET /api/health`リクエスト（負荷測定）
  - **境界値選択の根拠**: NFR-002の500ms以内レスポンス要件
  - **実際の使用場面**: ロードバランサーからの定期ヘルスチェック、監視システムからの確認
- **期待される結果**: 全リクエストが500ms未満で応答
  - **境界での正確性**: 応答時間が一貫して要件内に収まる
  - **一貫した動作**: 負荷状況に関係なく安定したレスポンス時間
- **テストの目的**: パフォーマンス要件の確認
  - **堅牢性の確認**: 高頻度アクセス時でも性能要件を満たすことを保証
- 🟢 **青信号**: NFR-002の具体的なパフォーマンス要件に基づく

### 3.3 データベース接続プールの境界値テスト

- **テスト名**: 最大接続数（10接続）での安定動作確認
  - **境界値の意味**: architecture.mdで定義された最大接続数での動作限界
  - **境界値での動作保証**: 接続プール上限に達した際の適切な処理
- **入力値**: 同時に10個のデータベース接続を要求
  - **境界値選択の根拠**: architecture.mdで定義された最大10接続の制限
  - **実際の使用場面**: 高負荷時の同時アクセス、複数のヘルスチェック要求
- **期待される結果**: 10接続まで正常処理、11接続目は適切な待機またはエラー処理
  - **境界での正確性**: 接続プール制限が正確に機能する
  - **一貫した動作**: リソース制限内で安定したデータベース操作
- **テストの目的**: リソース管理の境界確認
  - **堅牢性の確認**: 高負荷時でもシステムが安定動作し、リソース枯渇を防ぐ
- 🟢 **青信号**: architecture.mdの具体的な接続プール設定に基づく

---

## テストケース実装時の日本語コメント指針

### テストケース開始時のコメント

```typescript
// 【テスト目的】: [このテストで何を確認するかを日本語で明記]
// 【テスト内容】: [具体的にどのような処理をテストするかを説明]
// 【期待される動作】: [正常に動作した場合の結果を説明]
// 🟢🟡🔴 この内容の信頼性レベルを記載
```

### Given（準備フェーズ）のコメント

```typescript
// 【テストデータ準備】: [なぜこのデータを用意するかの理由]
// 【初期条件設定】: [テスト実行前の状態を説明]
// 【前提条件確認】: [テスト実行に必要な前提条件を明記]
```

### When（実行フェーズ）のコメント

```typescript
// 【実際の処理実行】: [どの機能/メソッドを呼び出すかを説明]
// 【処理内容】: [実行される処理の内容を日本語で説明]
// 【実行タイミング】: [なぜこのタイミングで実行するかを説明]
```

### Then（検証フェーズ）のコメント

```typescript
// 【結果検証】: [何を検証するかを具体的に説明]
// 【期待値確認】: [期待される結果とその理由を説明]
// 【品質保証】: [この検証がシステム品質にどう貢献するかを説明]
```

### 各expectステートメントのコメント

```typescript
// 【検証項目】: [この検証で確認している具体的な項目]
// 🟢🟡🔴 この内容の信頼性レベルを記載
expect(response.status).toBe(200); // 【確認内容】: HTTPステータス200が正常に返されることを確認
expect(response.body.status).toBe('healthy'); // 【確認内容】: ヘルスチェックステータスが'healthy'であることを確認
```

### セットアップ・クリーンアップのコメント

```typescript
beforeEach(() => {
  // 【テスト前準備】: [各テスト実行前に行う準備作業の説明]
  // 【環境初期化】: [テスト環境をクリーンな状態にする理由と方法]
});

afterEach(() => {
  // 【テスト後処理】: [各テスト実行後に行うクリーンアップ作業の説明]
  // 【状態復元】: [次のテストに影響しないよう状態を復元する理由]
});
```

---

## テストケース統計

- **正常系テストケース**: 5件
- **異常系テストケース**: 3件  
- **境界値テストケース**: 3件
- **合計**: 11件

## 信頼性レベル分析

- 🟢 **青信号**: 9件 (82%) - 要件定義書・設計文書に基づく
- 🟡 **黄信号**: 2件 (18%) - 妥当な推測による補完
- 🔴 **赤信号**: 0件 (0%) - 推測なし

## 対応要件

### 機能要件
- **REQ-403**: TypeScript実装 ✅
- **REQ-404**: JSON型禁止（PostgreSQL使用） ✅

### 非機能要件  
- **NFR-002**: 500ms以内レスポンス ✅
- **NFR-101**: CORS設定 ✅

### エッジケース
- **EDGE-001**: データベース接続失敗 ✅
- **EDGE-002**: サーバーエラー ✅

### 受け入れ基準
- [ ] `GET /api/health`が200を返す
- [ ] データベースに接続できる  
- [ ] CORSが設定されている
- [ ] TypeScriptで実装されている
- [ ] 基本的なセキュリティヘッダーが設定されている
- [ ] エラーハンドリングが適切に動作する