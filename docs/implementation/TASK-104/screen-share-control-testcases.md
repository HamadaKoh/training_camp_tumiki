# TASK-104: 画面共有制御機能実装 - TDDテストケース洗い出し

## 開発言語・フレームワーク

- **プログラミング言語**: TypeScript
  - **言語選択の理由**: 排他制御ロジックの型安全性、Socket.IOとの親和性、複雑な状態管理の安全性確保
  - **テストに適した機能**: インターフェース定義による明確な画面共有契約、Mock/Stubによる排他制御テスト
- **テストフレームワーク**: Jest + Socket.IO Client (テスト用) + Screen Share Mock
  - **フレームワーク選択の理由**: 画面共有特有の排他制御テスト、リアルタイム状態同期のイベント駆動テスト
  - **テスト実行環境**: Socket.IOテストクライアント、ScreenShareAPIモック、複数接続シミュレーション
- 🟢 既存プロジェクトの技術スタック（REQ-402, REQ-406）準拠、TASK-102参加者管理・TASK-103シグナリング基盤に依存

## 1. 正常系テストケース（基本的な動作）

### 1.1 ScreenShareManagerクラス初期化テスト
- **テスト名**: ScreenShareManagerクラスが正常に初期化できる
  - **何をテストするか**: ScreenShareManagerインスタンス生成とSocket.IOイベントハンドラー登録
  - **期待される動作**: request-screen-share, stop-screen-shareイベントリスナーの正常登録
- **入力値**: Socket.IOサーバーインスタンス、RoomManagerインスタンス
  - **入力データの意味**: 画面共有制御機能に必要な依存コンポーネント
- **期待される結果**: 正常インスタンス生成、イベントハンドラー登録確認、初期状態（共有者なし）
  - **期待結果の理由**: 画面共有排他制御基盤の初期化確認
- **テストの目的**: 画面共有制御基盤の正常性確認
  - **確認ポイント**: イベントリスナー登録、依存関係注入、初期状態（共有中でない）
- 🟢 要件定義書のScreenShareManagerクラス設計に基づく

### 1.2 画面共有開始許可テスト
- **テスト名**: 未使用状態での画面共有開始リクエストが正常に許可される
  - **何をテストするか**: 'request-screen-share'イベント受信時の排他チェックと許可処理
  - **期待される動作**: 排他確認、共有者設定、状態更新、全参加者通知
- **入力値**: participant-A からの画面共有開始リクエスト
  - **入力データの意味**: 誰も画面共有していない状態での正当な開始要求
- **期待される結果**: 
  ```typescript
  {
    success: true,
    granted: true,
    error: undefined
  }
  ```
  - **期待結果の理由**: REQ-005（画面共有開始ボタン）、REQ-104（画面共有配信）の実現
- **テストの目的**: 基本的な画面共有許可機能の動作確認
  - **確認ポイント**: 排他制御、状態管理、全参加者への'screen-share-started'通知
- 🟢 要件定義書の正常な画面共有開始フロー、REQ-005要件に基づく

### 1.3 画面共有停止処理テスト
- **テスト名**: 共有者による画面共有停止リクエストが正常に処理される
  - **何をテストするか**: 'stop-screen-share'イベント受信時の権限確認と停止処理
  - **期待される動作**: 共有者確認、状態クリア、全参加者通知
- **入力値**: 現在共有中のparticipant-Aからの停止リクエスト
  - **入力データの意味**: 正当な共有者による自主的な共有終了
- **期待される結果**: 画面共有状態クリア、'screen-share-stopped'イベント配信
  - **期待結果の理由**: REQ-005（画面共有停止ボタン）の実現
- **テストの目的**: 正常な画面共有停止機能の確認
  - **確認ポイント**: 権限確認、状態クリア、全参加者通知
- 🟢 要件定義書の正常な画面共有停止フロー、REQ-005要件に基づく

### 1.4 画面共有状態同期テスト
- **テスト名**: 新規参加者に現在の画面共有状態が正確に同期される
  - **何をテストするか**: join-room時の画面共有状態通知機能
  - **期待される動作**: 現在の共有者情報を新規参加者に配信
- **入力値**: participant-Aが画面共有中の状態でのparticipant-B参加
  - **入力データの意味**: 途中参加時の状態同期要件
- **期待される結果**: participant-Bへの'screen-share-started'イベント配信（participantId: participant-A）
  - **期待結果の理由**: 状態一貫性維持、視覚的情報共有の継続性
- **テストの目的**: 状態同期機能の正確性確認
  - **確認ポイント**: 新規参加者への状態通知、現在の共有者情報精度
- 🟢 参加者状態同期要件、画面共有状態管理に基づく

### 1.5 データベース画面共有記録テスト
- **テスト名**: 画面共有の開始・停止がデータベースに正確に記録される
  - **何をテストするか**: event_logsテーブルとroom_snapshotsテーブルへの記録処理
  - **期待される動作**: 開始時・停止時の完全なログ記録、状態スナップショット更新
- **入力値**: 画面共有開始→停止の一連の流れ
  - **入力データの意味**: 実際の画面共有セッションの記録要件
- **期待される結果**: event_logsレコード（screen_share_start, screen_share_stop）、room_snapshotsのscreen_sharing_active更新
  - **期待結果の理由**: database-schema.sql設計と監査要件
- **テストの目的**: データ永続化の完全性確認
  - **確認ポイント**: トランザクション整合性、記録の完全性、タイムスタンプ精度
- 🟢 database-schema.sql仕様、イベント記録要件に基づく

### 1.6 共有者切断時の自動停止テスト
- **テスト名**: 画面共有中の参加者切断時に自動的に共有が停止される
  - **何をテストするか**: Socket.IO切断検知による自動停止処理
  - **期待される動作**: 切断検知、自動状態クリア、全参加者への停止通知
- **入力値**: 画面共有中のparticipant-AのSocket.IO切断
  - **入力データの意味**: ネットワーク障害や突然の切断による状態整合性維持
- **期待される結果**: 自動画面共有停止、'screen-share-stopped'イベント配信、状態クリア
  - **期待結果の理由**: 孤立した画面共有状態の防止、視覚的情報共有の継続性確保
- **テストの目的**: 自動クリーンアップ機能の確認
  - **確認ポイント**: 切断検知、自動処理、状態整合性維持
- 🟡 要件定義書の共有者切断ケース、Socket.IO切断処理に基づく

## 2. 異常系テストケース（エラーハンドリング）

### 2.1 同時画面共有競合エラーテスト
- **テスト名**: 既に共有中の状態での新規共有リクエスト時にSCREEN_SHARE_IN_USEエラーが返される
  - **エラーケースの概要**: 排他制御違反時の適切な拒否処理
  - **エラー処理の重要性**: 複数画面共有による混乱防止、視覚的情報共有の秩序維持
- **入力値**: participant-Aが共有中の状態でのparticipant-Bからの開始リクエスト
  - **不正な理由**: REQ-405（同時に1人のみ画面共有可能）違反
  - **実際の発生シナリオ**: 複数参加者による同時画面共有試行
- **期待される結果**: 
  ```typescript
  {
    success: false,
    granted: false,
    error: {
      code: "SCREEN_SHARE_IN_USE",
      message: "他の参加者が画面共有中です"
    }
  }
  ```
  - **エラーメッセージの内容**: ユーザーフレンドリーな日本語メッセージ、現状説明
  - **システムの安全性**: 既存共有への影響なし、排他制御維持
- **テストの目的**: 排他制御機能の実効性確認
  - **品質保証の観点**: 視覚的情報共有の秩序、複数共有による混乱防止
- 🟢 EDGE-101（同時画面共有開始時の先着順）、REQ-105、REQ-405要件に基づく

### 2.2 権限なし停止試行エラーテスト
- **テスト名**: 共有者以外による画面共有停止試行時に権限エラーが返される
  - **エラーケースの概要**: 不正な停止操作の防止
  - **エラー処理の重要性**: 画面共有制御の権限管理、不正操作防止
- **入力値**: participant-Aが共有中の状態でのparticipant-Bからの停止リクエスト
  - **不正な理由**: 共有者以外による制御権限なし
  - **実際の発生シナリオ**: 他参加者による誤操作、悪意のある停止試行
- **期待される結果**: 権限エラー、画面共有状態継続、停止処理拒否
  - **エラーメッセージの内容**: 権限不足を示すメッセージ
  - **システムの安全性**: 不正な制御からの画面共有保護
- **テストの目的**: 権限管理機能の実効性確認
  - **品質保証の観点**: セキュリティ境界の維持、不正操作防止
- 🟡 権限管理要件からの推測、画面共有制御セキュリティ

### 2.3 存在しない参加者による画面共有リクエストエラー
- **テスト名**: 参加者リストにない送信者からの画面共有リクエスト時に認証エラーが返される
  - **エラーケースの概要**: 無効な参加者からの画面共有試行
  - **エラー処理の重要性**: なりすまし防止、不正アクセス遮断
- **入力値**: 存在しないparticipant-ID "invalid-participant" からの開始リクエスト
  - **不正な理由**: 参加者として登録されていない無効なID
  - **実際の発生シナリオ**: 不正なクライアント、認証なしアクセス試行
- **期待される結果**: 参加者認証エラー、画面共有リクエスト拒否
  - **エラーメッセージの内容**: 認証失敗を示すセキュリティメッセージ
  - **システムの安全性**: 不正参加者からの攻撃防止
- **テストの目的**: 参加者認証機能の実効性確認
  - **品質保証の観点**: セキュリティ境界の堅牢性、なりすまし防止
- 🟡 参加者認証要件、セキュリティ要件からの推測

### 2.4 データベース記録失敗時の処理テスト
- **テスト名**: DB記録失敗時に画面共有開始処理がロールバックされる
  - **エラーケースの概要**: データベース障害時の状態整合性保護
  - **エラー処理の重要性**: データ不整合防止、システム信頼性維持
- **入力値**: DB接続不可状態での画面共有開始リクエスト
  - **不正な理由**: インフラ障害、ネットワーク問題
  - **実際の発生シナリオ**: DB メンテナンス、ネットワーク分断、高負荷時
- **期待される結果**: 画面共有開始失敗、インメモリ状態変更なし、エラー応答
  - **エラーメッセージの内容**: 一時的な障害を示すメッセージ
  - **システムの安全性**: 部分的な状態変更の回避、整合性維持
- **テストの目的**: トランザクション整合性の確認
  - **品質保証の観点**: データ整合性、障害時の安全な動作
- 🟡 アトミック操作要件、DB障害時の処理からの推測

### 2.5 画面共有配信失敗時の処理テスト
- **テスト名**: 画面共有配信中のネットワーク障害時に適切な処理が行われる
  - **エラーケースの概要**: 配信中の技術的障害への対応
  - **エラー処理の重要性**: 障害時の自動回復、ユーザー体験の維持
- **入力値**: 画面共有配信中のネットワーク品質低下・切断
  - **不正な理由**: インフラ障害、帯域不足
  - **実際の発生シナリオ**: モバイル通信切断、Wi-Fi不安定、サーバー負荷
- **期待される結果**: 配信失敗検知、自動再試行または停止処理、エラー通知
  - **エラーメッセージの内容**: 配信障害を示すメッセージ
  - **システムの安全性**: 障害の自動検知と対応
- **テストの目的**: 配信障害時の自動処理確認
  - **品質保証の観点**: 障害耐性、自動回復機能
- 🟡 NFR-002（画面共有遅延500ms以内）関連の障害処理からの推測

## 3. 境界値テストケース（最小値、最大値、null等）

### 3.1 最大参加者数（10人）での画面共有テスト
- **テスト名**: 10人参加時の画面共有開始・状態同期が正常に処理される
  - **境界値の意味**: NFR-004要件の上限での画面共有制御性能
  - **境界値での動作保証**: 最大負荷時の画面共有品質維持
- **入力値**: 10人参加状態での画面共有開始・全員への状態同期
  - **境界値選択の根拠**: NFR-004「最大10人同時参加」での最大通知負荷
  - **実際の使用場面**: 満室での大規模プレゼンテーション
- **期待される結果**: 全10人への正確な画面共有通知、処理遅延なし
  - **境界での正確性**: 通知配信精度、処理時間維持
  - **一貫した動作**: 参加者数に関わらない画面共有品質
- **テストの目的**: 最大負荷時の画面共有性能確認
  - **堅牢性の確認**: 複雑な通知配信での安定性、スケーラビリティ限界
- 🟢 NFR-004要件、最大参加者での画面共有配信に基づく

### 3.2 画面共有処理時間境界値（500ms以内）テスト
- **テスト名**: 画面共有開始処理が500ms以内で完了する
  - **境界値の意味**: NFR-002要件の画面共有遅延上限での性能検証
  - **境界値での動作保証**: 低遅延要件を満たす画面共有性能
- **入力値**: 高負荷状態（9人参加）での画面共有開始処理
  - **境界値選択の根拠**: NFR-002「画面共有遅延500ms以内」要件
  - **実際の使用場面**: リアルタイムプレゼンテーションでの即座な画面共有
- **期待される結果**: 500ms以内の開始完了、機能品質維持
  - **境界での正確性**: 処理時間測定、レスポンシブ性能
  - **一貫した動作**: 負荷状況に関わらない応答速度
- **テストの目的**: 画面共有性能要件の遵守確認
  - **堅牢性の確認**: 高負荷時でも低遅延画面共有の実現
- 🟢 NFR-002要件「画面共有遅延500ms以内」に基づく

### 3.3 画面共有セッション継続時間境界値テスト
- **テスト名**: 長時間（1時間）の画面共有セッションが安定して維持される
  - **境界値の意味**: 実用的な最大セッション時間での安定性検証
  - **境界値での動作保証**: 長時間使用での状態管理安定性
- **入力値**: 1時間継続の画面共有セッション
  - **境界値選択の根拠**: 実際の会議・プレゼンテーションの最大時間想定
  - **実際の使用場面**: 長時間のワークショップ、詳細プレゼンテーション
- **期待される結果**: 1時間の安定した状態維持、メモリリークなし、配信品質維持
  - **境界での正確性**: 長時間の状態整合性、リソース管理
  - **一貫した動作**: 時間経過に関わらない機能品質
- **テストの目的**: 長時間セッションでの安定性確認
  - **堅牢性の確認**: メモリ管理、長時間の状態維持能力
- 🟡 実用的な使用時間からの境界値推測

### 3.4 同時リクエスト処理境界値テスト
- **テスト名**: 複数参加者からの同時画面共有リクエストで先着順制御が正確に動作する
  - **境界値の意味**: 同時アクセス時の排他制御精度検証
  - **境界値での動作保証**: 競合状態での正確な先着順判定
- **入力値**: 2人の参加者による同一タイミングでの画面共有開始リクエスト
  - **境界値選択の根拠**: EDGE-101「同時画面共有開始時の先着順」要件
  - **実際の使用場面**: 複数参加者による画面共有競合状況
- **期待される結果**: 1人の画面共有許可、他1人のSCREEN_SHARE_IN_USEエラー、処理順序の一貫性
  - **境界での正確性**: 排他制御精度、レースコンディション回避
  - **一貫した動作**: 同時アクセス時の予測可能な結果
- **テストの目的**: 排他制御の精度確認
  - **堅牢性の確認**: 競合状態での正確な制御、データ整合性
- 🟢 EDGE-101要件「同時画面共有開始時の先着順」に基づく

### 3.5 null/undefined値での画面共有エラーテスト
- **テスト名**: null/undefined値を含む画面共有リクエストで適切なエラーが返される
  - **境界値の意味**: 無効データでの防御機能、型安全性の実効性
  - **境界値での動作保証**: 不正データへの堅牢な対応
- **入力値**: null participantId、undefined画面共有データ等の無効データ
  - **境界値選択の根拠**: TypeScript型定義の境界における安全性確認
  - **実際の使用場面**: クライアント側バグ、ネットワークデータ破損
- **期待される結果**: 適切なバリデーションエラー、画面共有リクエスト拒否
  - **境界での正確性**: 型検証、データ完全性チェック
  - **一貫した動作**: 無効データの確実な検出と拒否
- **テストの目的**: データ検証機能の完全性確認
  - **堅牢性の確認**: 型安全性実現、不正データ防御
- 🟡 TypeScript型定義、データ検証要件からの堅牢性推測

## 品質判定

✅ **高品質**:
- テストケース分類: 正常系・異常系・境界値が網羅されている（6正常系・5異常系・5境界値）
- 期待値定義: 各テストケースの期待値が明確（画面共有制御、Socket.IOイベント、排他制御、エラーハンドリング詳細）
- 技術選択: プログラミング言語・テストフレームワークが確定（TypeScript + Jest + Socket.IO Client + Screen Share Mock）
- 実装可能性: 現在の技術スタックで実現可能（TASK-102・TASK-103基盤上、画面共有排他制御）

## 次のステップ

次のおすすめステップ: `/tdd-red` でRedフェーズ（失敗テスト作成）を開始します。