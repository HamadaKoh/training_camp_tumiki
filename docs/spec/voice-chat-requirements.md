# ボイスチャットWebアプリケーション 要件定義書

## 概要

複数人が同時に参加できる通話・画面共有機能を持つWebアプリケーション。単一の通話ルームで、参加者全員が音声通話を行いながら、1人のユーザーが画面共有を行える。6時間以内で実装可能な最小限の機能セットに焦点を当てた設計。

## ユーザストーリー

### ストーリー1: 音声通話への参加

- **である** リモートワーカー **として**
- **私は** ワンクリックで通話ルームに参加 **したい**
- **そうすることで** チームメンバーと即座にコミュニケーションが取れる

### ストーリー2: 画面共有による情報共有

- **である** プレゼンター **として**
- **私は** 自分の画面を他の参加者に共有 **したい**
- **そうすることで** 視覚的な情報を効率的に伝えられる

### ストーリー3: 通話品質の確認

- **である** 通話参加者 **として**
- **私は** 自分の接続状態と他の参加者の状態を確認 **したい**
- **そうすることで** 通話品質の問題を素早く特定できる

## 機能要件（EARS記法）

### 通常要件（SHALL）

- REQ-001: システムは 単一の通話ルームを提供 しなければならない
- REQ-002: システムは 参加ボタンクリックで即座にルームに参加できる機能を提供 しなければならない
- REQ-003: システムは 参加者全員の音声をリアルタイムで送受信 しなければならない
- REQ-004: システムは 現在の参加者リストを表示 しなければならない
- REQ-005: システムは 画面共有開始/停止ボタンを提供 しなければならない
- REQ-006: システムは 自分のマイクのミュート/ミュート解除機能を提供 しなければならない
- REQ-007: システムは 通話からの退出機能を提供 しなければならない

### 条件付き要件（WHEN/IF-THEN）

- REQ-101: ユーザーが参加ボタンをクリックした 場合、システムは マイク使用許可を要求 しなければならない
- REQ-102: 新しい参加者が入室した 場合、システムは 既存参加者に通知 しなければならない
- REQ-103: 参加者が退出した 場合、システムは 他の参加者に通知 しなければならない
- REQ-104: ユーザーが画面共有を開始した 場合、システムは 他の全参加者に画面を配信 しなければならない
- REQ-105: 既に画面共有中に他のユーザーが共有を試みた 場合、システムは エラーメッセージを表示 しなければならない
- REQ-106: ネットワーク接続が不安定な 場合、システムは 接続状態インジケーターを表示 しなければならない

### 状態要件（WHERE）

- REQ-201: 通話に参加している 状態で、システムは 退出ボタンを表示 しなければならない
- REQ-202: マイクがミュート 状態で、システムは ミュートアイコンを表示 しなければならない
- REQ-203: 画面共有中 の状態で、システムは 共有停止ボタンを表示 しなければならない
- REQ-204: 未参加 状態で、システムは 参加ボタンのみを表示 しなければならない

### オプション要件（MAY）

- REQ-301: システムは チャット機能を提供 してもよい
- REQ-302: システムは 参加者のビデオ表示機能を提供 してもよい
- REQ-303: システムは 音声品質インジケーターを表示 してもよい
- REQ-304: システムは 画面共有の解像度選択機能を提供 してもよい

### 制約要件（MUST）

- REQ-401: システムは WebRTCを使用して通信を実装 しなければならない
- REQ-402: バックエンドは TypeScript（Node.js）で実装 しなければならない
- REQ-403: フロントエンドは React + TypeScriptで実装 しなければならない
- REQ-404: システムは GKE上で動作可能 でなければならない
- REQ-405: システムは 同時に1人のみ画面共有可能 でなければならない
- REQ-406: システムは WebSocketまたはSocket.IOを使用してシグナリング しなければならない

## 非機能要件

### パフォーマンス

- NFR-001: 音声遅延は 200ms以内である必要がある
- NFR-002: 画面共有の遅延は 500ms以内である必要がある
- NFR-003: 参加/退出の処理は 1秒以内に完了する必要がある
- NFR-004: システムは 最大10人の同時参加をサポートする必要がある

### セキュリティ

- NFR-101: システムは HTTPS接続を使用する必要がある
- NFR-102: システムは WebRTC通信を暗号化する必要がある
- NFR-103: システムは CORS設定で適切なオリジンのみ許可する必要がある

### ユーザビリティ

- NFR-201: システムは ワンクリックで通話に参加できる必要がある
- NFR-202: システムは 直感的なUIで3クリック以内に全機能にアクセスできる必要がある
- NFR-203: システムは マイクの状態を視覚的に明確に表示する必要がある

### 可用性

- NFR-301: システムは 参加者の途中退出に対して堅牢である必要がある
- NFR-302: システムは ネットワーク一時切断から自動回復する必要がある

## エッジケース

### 接続エラー

- EDGE-001: WebRTC接続が確立できない場合、「接続に失敗しました。ネットワーク設定を確認してください」と表示
- EDGE-002: シグナリングサーバーに接続できない場合、「サーバーに接続できません」と表示
- EDGE-003: マイク許可が拒否された場合、「マイクの使用を許可してください」と表示

### 同時実行制御

- EDGE-101: 2人が同時に画面共有を開始した場合、先に開始した方を優先
- EDGE-102: 参加者が上限（10人）に達した場合、「ルームが満員です」と表示
- EDGE-103: 同じユーザーが複数タブから参加した場合、別々の参加者として扱う

### ネットワーク品質

- EDGE-201: パケットロスが10%を超えた場合、音声品質警告を表示
- EDGE-202: 帯域幅が不足した場合、画面共有の品質を自動調整
- EDGE-203: 完全にオフラインになった場合、自動的に退出処理

## 受け入れ基準

### 機能テスト

#### 基本通話機能
- [ ] 参加ボタンクリックで通話ルームに参加できる
- [ ] 複数人が同時に通話できる（最低3人でテスト）
- [ ] マイクのミュート/ミュート解除が機能する
- [ ] 退出ボタンで通話から離脱できる
- [ ] 参加者リストが正確に表示される

#### 画面共有機能
- [ ] 画面共有を開始できる
- [ ] 他の参加者に画面が表示される
- [ ] 画面共有を停止できる
- [ ] 同時に1人のみ画面共有できることを確認

#### 通知機能
- [ ] 新規参加者の入室が通知される
- [ ] 参加者の退出が通知される
- [ ] 画面共有の開始/終了が通知される

### 非機能テスト

#### パフォーマンステスト
- [ ] 3人同時通話で音声遅延が200ms以内
- [ ] 画面共有の遅延が500ms以内
- [ ] 10人同時接続が可能

#### エラーハンドリング
- [ ] マイク許可拒否時に適切なメッセージ表示
- [ ] ネットワークエラー時に再接続を試行
- [ ] 画面共有競合時にエラーメッセージ表示

### 技術仕様テスト

- [ ] TypeScriptでバックエンドが実装されている
- [ ] React + TypeScriptでフロントエンドが実装されている
- [ ] WebRTCを使用している
- [ ] GKEでデプロイ可能な構成

## 実装タスク分割（6時間以内）

### タスク1: 基本プロジェクト構成（30分）
- フロントエンド/バックエンドのプロジェクト初期化
- 必要なパッケージのインストール
- 基本的なビルド設定

### タスク2: シグナリングサーバー実装（1時間）
- WebSocketサーバーのセットアップ
- 入退室管理
- シグナリングメッセージの中継

### タスク3: フロントエンド基本UI（1時間）
- 参加/退出ボタン
- 参加者リスト
- マイクコントロール
- 画面共有ボタン

### タスク4: WebRTC音声通話実装（1.5時間）
- PeerConnection管理
- 音声ストリームの送受信
- 複数ピア接続の管理

### タスク5: 画面共有機能実装（1時間）
- 画面キャプチャAPI統合
- 画面共有ストリームの配信
- 排他制御の実装

### タスク6: エラーハンドリングとテスト（1時間）
- 接続エラー処理
- 基本的な動作テスト
- デプロイ準備

## 技術スタック

### フロントエンド
- React 18+
- TypeScript 5+
- Socket.IO Client
- WebRTC API

### バックエンド
- Node.js 18+
- TypeScript 5+
- Express
- Socket.IO

### インフラ
- GKE (Google Kubernetes Engine)
- Docker
- Kubernetes manifests

## 最小実装範囲（MVP）

1. 単一ルームへの参加/退出
2. 音声通話（ミュート機能付き）
3. 画面共有（1人のみ）
4. 参加者リスト表示
5. 基本的なエラーハンドリング

## 将来の拡張候補（CI/CD実装後）

- 複数ルーム対応
- ビデオ通話機能
- チャット機能
- 録画機能
- 認証機能
- ルーム作成/管理機能