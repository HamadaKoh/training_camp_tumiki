# ボイスチャットWebアプリケーション アーキテクチャ設計

## システム概要

リアルタイム音声通話と画面共有機能を提供するWebアプリケーション。WebRTCを使用してP2P通信を実現し、Socket.IOによるシグナリングサーバーで接続を管理する。シンプルな単一ルーム構成で、最大10人の同時参加をサポート。

## アーキテクチャパターン

- **パターン**: クライアント・サーバー + P2Pハイブリッド
- **理由**: 
  - シグナリングとルーム管理はサーバーで集中管理
  - メディアストリームはWebRTCによるP2P通信で直接送受信
  - 低遅延と効率的な帯域使用を実現

## システムアーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────┐
│                         Google Cloud Platform                    │
│                                                                  │
│  ┌──────────────────────────────────────────────────────────┐  │
│  │                    GKE Autopilot Cluster                   │  │
│  │                                                            │  │
│  │  ┌─────────────────┐      ┌──────────────────────────┐  │  │
│  │  │  Load Balancer  │      │    Signaling Server      │  │  │
│  │  │   (HTTPS/WSS)   │─────▶│  (Node.js + Socket.IO)  │  │  │
│  │  └─────────────────┘      └──────────────────────────┘  │  │
│  │                                        │                   │  │
│  │                                        ▼                   │  │
│  │                            ┌──────────────────────────┐  │  │
│  │                            │      PostgreSQL DB       │  │  │
│  │                            │   (Session Management)   │  │  │
│  │                            └──────────────────────────┘  │  │
│  └──────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                                    │
                                    │ WebSocket
                                    │ (Signaling)
                                    │
┌─────────────────────┐             │           ┌─────────────────────┐
│   Client Browser 1  │◀────────────┴──────────▶│   Client Browser 2  │
│  (React + WebRTC)   │                         │  (React + WebRTC)   │
└─────────────────────┘                         └─────────────────────┘
         │                                                 │
         │              WebRTC P2P Connection             │
         └────────────────────────────────────────────────┘
                    (Audio/Screen Share Streams)
```

## コンポーネント構成

### フロントエンド

- **フレームワーク**: React 18 + TypeScript
- **状態管理**: React Context API (シンプルな状態管理)
- **通信ライブラリ**: 
  - Socket.IO Client (シグナリング)
  - WebRTC API (メディアストリーム)
- **UIコンポーネント構成**:
  - RoomView (メインコンテナ)
  - ParticipantsList (参加者一覧)
  - MediaControls (ミュート/画面共有ボタン)
  - ConnectionStatus (接続状態表示)

### バックエンド

- **フレームワーク**: Express + TypeScript
- **リアルタイム通信**: Socket.IO
- **認証方式**: なし（MVPでは認証なし）
- **主要モジュール**:
  - SignalingHandler (WebRTCシグナリング処理)
  - RoomManager (参加者管理)
  - ScreenShareManager (画面共有排他制御)

### データベース

- **DBMS**: PostgreSQL 14+
- **用途**: セッション管理、参加者情報の永続化
- **キャッシュ**: なし（MVPではインメモリで管理）

## 通信フロー

### 1. 参加フロー
```
1. クライアント → サーバー: Socket.IO接続
2. サーバー: 参加者をルームに追加
3. サーバー → 全クライアント: 参加者リスト更新通知
4. 新規参加者 ↔ 既存参加者: WebRTC接続確立
```

### 2. WebRTC接続確立
```
1. Peer A → サーバー → Peer B: Offer送信
2. Peer B → サーバー → Peer A: Answer送信
3. Peer A ↔ サーバー ↔ Peer B: ICE候補交換
4. Peer A ↔ Peer B: P2P接続確立
```

### 3. 画面共有フロー
```
1. クライアント → サーバー: 画面共有リクエスト
2. サーバー: 排他制御チェック
3. サーバー → クライアント: 許可/拒否
4. クライアント → 全ピア: 画面共有ストリーム送信
```

## スケーラビリティ設計

### 水平スケーリング
- **現在**: 単一インスタンス（MVP）
- **将来**: 
  - Redis/Redisクラスターでセッション共有
  - 複数シグナリングサーバーインスタンス
  - Sticky Sessionまたはメッセージブローカー使用

### 制限事項
- 単一ルームのため、参加者数は10人まで
- メッシュ型接続のため、参加者数の2乗で接続数が増加

## セキュリティ設計

### 通信セキュリティ
- HTTPS/WSSによる暗号化通信
- WebRTCのDTLS/SRTPによるメディア暗号化

### アクセス制御
- CORS設定による不正アクセス防止
- 将来的にJWTトークンによる認証を追加可能

## デプロイメント設計

### コンテナ構成
```yaml
Backend Container:
  - Node.js 18 Alpine
  - Express + Socket.IO
  - 環境変数で設定管理

Frontend Container:
  - Nginx Alpine
  - React SPA配信
  - リバースプロキシ設定
```

### Kubernetes構成
```yaml
Deployments:
  - backend-deployment (1 replica)
  - frontend-deployment (1 replica)
  
Services:
  - backend-service (ClusterIP)
  - frontend-service (ClusterIP)
  
Ingress:
  - Google Cloud Load Balancer
  - SSL終端
  - WebSocketサポート
```

## 監視・ログ設計

### メトリクス
- 接続中の参加者数
- WebRTC接続成功率
- 平均遅延時間

### ログ
- シグナリングイベント
- エラーログ
- 接続/切断イベント

## 技術的決定事項

### WebRTCトポロジー: メッシュ型
- **理由**: 実装がシンプル、10人以下なら実用的
- **代替案**: SFU（将来の拡張時に検討）

### シグナリングプロトコル: Socket.IO
- **理由**: 
  - リアルタイム双方向通信
  - 自動再接続機能
  - ルーム管理機能内蔵

### 状態管理: サーバー側で集中管理
- **理由**: 
  - 状態の一貫性保証
  - 参加者の同期が簡単
  - クライアント側の実装簡素化